<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRMTogether PWA Host - URI Protocol Test</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #fafafa;
        }
        .test-section h3 {
            color: #34495e;
            margin-top: 0;
        }
        .test-button {
            display: inline-block;
            padding: 12px 24px;
            margin: 8px;
            background-color: #3498db;
            color: white;
            text-decoration: none;
            border-radius: 5px;
            border: none;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
        }
        .test-button:hover {
            background-color: #2980b9;
        }
        .test-button.danger {
            background-color: #e74c3c;
        }
        .test-button.danger:hover {
            background-color: #c0392b;
        }
        .test-button.success {
            background-color: #27ae60;
        }
        .test-button.success:hover {
            background-color: #229954;
        }
        .uri-display {
            background-color: #2c3e50;
            color: #ecf0f1;
            padding: 10px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            margin: 10px 0;
            word-break: break-all;
        }
        .description {
            color: #7f8c8d;
            font-size: 14px;
            margin-bottom: 15px;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-weight: bold;
        }
        .status.info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .status.warning {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöÄ CRMTogether PWA Host - URI Protocol Test</h1>
        
        <div class="status info">
            <strong>Instructions:</strong> Click the buttons below to test different URI protocol commands. 
            Make sure CRMTogether.PwaHost.exe is running first!
        </div>

        <div class="status warning">
            <strong>Note:</strong> JavaScript code in URIs must be URL-encoded. Special characters like quotes, spaces, and parentheses are encoded as %27, %20, %28, %29, etc.
        </div>

        <!-- Basic Navigation Tests -->
        <div class="test-section">
            <h3>üåê Basic Navigation Tests</h3>
            <div class="description">
                Test basic URL navigation functionality
            </div>

            <a href="crmtog://navigate?url=https://appacpro.crmtogether.com" class="test-button">
                AC Pro  
            </a>            
            
            <a href="crmtog://navigate?url=https://appmxpro.crmtogether.com" class="test-button">
                MX Pro  
            </a>
            
            <a href="crmtog://navigate?url=https://appmxs100.crmtogether.com" class="test-button">
                MX S100
            </a>
            
            <a href="crmtog://navigate?url=https://appmxcreatio.crmtogether.com" class="test-button">
                MX Creatio
            </a>
            
            <div class="uri-display">crmtog://navigate?url=https://www.google.com</div>
        </div>        

        <!-- Basic Navigation Tests -->
        <div class="test-section">
            <h3>üåê Basic Navigation Tests</h3>
            <div class="description">
                Test basic URL navigation functionality
            </div>
            
            <a href="crmtog://navigate?url=https://www.google.com" class="test-button">
                Navigate to Google
            </a>
            
            <a href="crmtog://navigate?url=https://www.github.com" class="test-button">
                Navigate to GitHub
            </a>
            
            <a href="crmtog://navigate?url=https://www.stackoverflow.com" class="test-button">
                Navigate to Stack Overflow
            </a>
            
            <div class="uri-display">crmtog://navigate?url=https://www.google.com</div>
        </div>

        <!-- JavaScript Execution Tests -->
        <div class="test-section">
            <h3>‚ö° JavaScript Execution Tests</h3>
            <div class="description">
                Test JavaScript execution in the WebView2 control
            </div>
            
            <a href="crmtog://exec?js=alert(%27Hello%20from%20URI!%27)" class="test-button">
                Show Alert
            </a>
            
            <a href="crmtog://exec?js=document.body.style.backgroundColor%3D%27lightblue%27" class="test-button">
                Change Background
            </a>
            
            <a href="crmtog://exec?js=console.log(%27URI%20executed:%27%2C%20new%20Date())" class="test-button">
                Log to Console
            </a>
            
            <div class="uri-display">crmtog://exec?js=alert(%27Hello%20from%20URI!%27)</div>
        </div>

        <!-- JavaScript with Results -->
        <div class="test-section">
            <h3>üìä JavaScript with Results</h3>
            <div class="description">
                Test JavaScript execution that returns values
            </div>
            
            <a href="crmtog://execres?js=document.title" class="test-button">
                Get Page Title
            </a>
            
            <a href="crmtog://execres?js=window.location.href" class="test-button">
                Get Current URL
            </a>
            
            <a href="crmtog://execres?js=document.querySelectorAll(%27*%27).length" class="test-button">
                Count DOM Elements
            </a>
            
            <div class="uri-display">crmtog://execres?js=document.title</div>
        </div>

        <!-- Function Call Tests -->
        <div class="test-section">
            <h3>üîß Function Call Tests</h3>
            <div class="description">
                Test calling JavaScript functions with parameters
            </div>
            
            <a href="crmtog://call?name=alert&args=[%22Function%20called%20from%20URI!%22]" class="test-button">
                Call Alert Function
            </a>
            
            <a href="crmtog://call?name=setTimeout&args=[%22()%20%3D%3E%20alert(%27Delayed%20message!%27)%22%2C%202000]" class="test-button">
                Call setTimeout
            </a>
            
            <div class="uri-display">crmtog://call?name=alert&args=[%22Function%20called%20from%20URI!%22]</div>
        </div>

        <!-- Script Execution Tests -->
        <div class="test-section">
            <h3>üìú Script Execution Tests</h3>
            <div class="description">
                Test running registered JavaScript scripts
            </div>
            
            <a href="crmtog://script?name=testScript&args=arg1%2Carg2" class="test-button">
                Run Test Script
            </a>
            
            <a href="crmtog://script?name=myScript" class="test-button">
                Run My Script
            </a>
            
            <div class="uri-display">crmtog://script?name=testScript&args=arg1%2Carg2</div>
        </div>

        <!-- Short Form Tests -->
        <div class="test-section">
            <h3>‚ö° Short Form Tests</h3>
            <div class="description">
                Test simplified URI formats
            </div>
            
            <a href="crmtog://?url=https://www.microsoft.com" class="test-button">
                Navigate (Short Form)
            </a>
            
            <a href="crmtog://?script=myScript" class="test-button">
                Run Script (Short Form)
            </a>
            
            <div class="uri-display">crmtog://?url=https://www.microsoft.com</div>
        </div>

        <!-- Advanced Tests -->
        <div class="test-section">
            <h3>üî¨ Advanced Tests</h3>
            <div class="description">
                Test complex URI scenarios
            </div>
            
            <a href="crmtog://navigate?url=https://www.bing.com&method=navigate" class="test-button">
                Navigate with Method
            </a>
            
            <a href="crmtog://exec?js=window.open(%27https://www.google.com%27%2C%20%27_blank%27)" class="test-button danger">
                Open New Window
            </a>
            
            <a href="crmtog://execres?js=JSON.stringify({timestamp:%20Date.now(),%20userAgent:%20navigator.userAgent})" class="test-button">
                Get Browser Info
            </a>
            
            <div class="uri-display">crmtog://navigate?url=https://www.bing.com&method=navigate</div>
        </div>

        <!-- Phone File Download Tests -->
        <div class="test-section">
            <h3>üì± Phone File Download Tests</h3>
            <div class="description">
                Generate and download test files with .phone extension containing random phone numbers.
                <br><strong>Note:</strong> The CRMTogether PWA Host app watches your Downloads folder for .phone files.
                <br>After downloading, you can also drag the .phone file directly onto the app window.
            </div>
            
            <button onclick="downloadRandomPhoneFile()" class="test-button success">
                Download Random Phone File
            </button>
            
            <button onclick="downloadCustomPhoneFile()" class="test-button">
                Download Custom Phone File
            </button>
            
            <button onclick="downloadToDownloadsFolder()" class="test-button">
                Download to Downloads Folder
            </button>
            
            <div class="uri-display" id="phoneFileDisplay">Click a button above to generate a phone file</div>
            
            <div class="status info" style="margin-top: 15px;">
                <strong>Instructions:</strong>
                <br>1. Click "Download to Downloads Folder" to save directly to your Downloads folder
                <br>2. Or download normally and drag the .phone file onto the CRMTogether PWA Host app window
                <br>3. The app will process the phone number and call vueAppInstance.$phonebox.changeSelectedPhone()
            </div>
        </div>

        <!-- EML File Download Tests -->
        <div class="test-section">
            <h3>üìß EML File Download Tests</h3>
            <div class="description">
                Generate and download test files with .eml extension containing random email content.
                <br><strong>Note:</strong> The CRMTogether PWA Host app watches your Downloads folder for .eml files.
                <br>After downloading, you can also drag the .eml file directly onto the app window.
            </div>
            
            <button onclick="downloadRandomEmlFile()" class="test-button success">
                Download Random EML File
            </button>
            
            <button onclick="downloadCustomEmlFile()" class="test-button">
                Download Custom EML File
            </button>
            
            <button onclick="downloadEmlToDownloadsFolder()" class="test-button">
                Download EML to Downloads Folder
            </button>
            
            <div class="uri-display" id="emlFileDisplay">Click a button above to generate an EML file</div>
            
            <div class="status info" style="margin-top: 15px;">
                <strong>Instructions:</strong>
                <br>1. Click "Download EML to Downloads Folder" to save directly to your Downloads folder
                <br>2. Or download normally and drag the .eml file onto the CRMTogether PWA Host app window
                <br>3. The app will process the email and call changeSelectedEmail() function
            </div>
        </div>

        <!-- Test Results Area -->
        <div class="test-section">
            <h3>üìã Test Results</h3>
            <div class="description">
                Check the CRMTogether PWA Host application for results of your tests
            </div>
            
            <div class="status warning">
                <strong>Note:</strong> Results will appear in the CRMTogether PWA Host application window. 
                Make sure the app is running and visible to see the effects of your URI tests.
            </div>
        </div>

        <!-- OpenEntity Test -->
        <div class="test-section">
            <h3>üîó OpenEntity Tests</h3>
            <div class="description">
                Test the OpenEntity method with different entity types and contact information.
            </div>
            
            <button onclick="testOpenEntity('contact', '12345', 'john.doe@example.com', '+1234567890')" class="test-button success">
                Test Contact Entity
            </button>
            
            <button onclick="testOpenEntity('lead', '67890', 'jane.smith@example.com', '+0987654321')" class="test-button">
                Test Lead Entity
            </button>
            
            <button onclick="testOpenEntity('opportunity', 'abc123', 'sales@company.com', '+5555555555')" class="test-button">
                Test Opportunity Entity
            </button>
            
            <button onclick="testOpenEntity('account', 'xyz789', 'info@business.com', '')" class="test-button">
                Test Account Entity (No Phone)
            </button>
            
            <div class="uri-display" id="openEntityDisplay">Click a button above to test OpenEntity</div>
        </div>

        <!-- Manual URI Input -->
        <div class="test-section">
            <h3>‚úèÔ∏è Manual URI Test</h3>
            <div class="description">
                Test your own custom URIs
            </div>
            
            <input type="text" id="customUri" placeholder="Enter custom crmtog:// URI here" 
                   style="width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ddd; border-radius: 4px;">
            
            <button onclick="testCustomUri()" class="test-button success">
                Test Custom URI
            </button>
            
            <div class="uri-display" id="customUriDisplay">Enter a URI above to see it here</div>
        </div>
    </div>

    <script>
        function testOpenEntity(entityType, entityId, emailAddress, phoneNumber) {
            const display = document.getElementById('openEntityDisplay');
            
            try {
                // Build the crmtog:// URI for OpenEntity
                const uri = `crmtog://openEntity?entityType=${encodeURIComponent(entityType)}&entityId=${encodeURIComponent(entityId)}&emailAddress=${encodeURIComponent(emailAddress || '')}&phoneNumber=${encodeURIComponent(phoneNumber || '')}`;
                
                display.textContent = uri;
                
                // Navigate to the URI
                window.location.href = uri;
                
            } catch (e) {
                display.textContent = 'Error creating OpenEntity URI: ' + e.message;
                console.error('OpenEntity URI error:', e);
            }
        }

        function testCustomUri() {
            const uri = document.getElementById('customUri').value;
            const display = document.getElementById('customUriDisplay');
            
            if (!uri) {
                alert('Please enter a URI to test');
                return;
            }
            
            if (!uri.startsWith('crmtog://')) {
                alert('URI must start with crmtog://');
                return;
            }
            
            display.textContent = uri;
            
            // Try to navigate to the URI
            try {
                window.location.href = uri;
            } catch (e) {
                alert('Error testing URI: ' + e.message);
            }
        }

        // Add some test functions to the page for URI testing
        window.testFunction = function(message) {
            alert('Test function called with: ' + message);
            return 'Function executed successfully';
        };

        window.getPageInfo = function() {
            return {
                title: document.title,
                url: window.location.href,
                timestamp: new Date().toISOString(),
                userAgent: navigator.userAgent
            };
        };

        // Phone file download functions
        function generateRandomPhoneNumber() {
            // Generate a random phone number in various formats
            const formats = [
                // US format: (XXX) XXX-XXXX
                () => `(${Math.floor(Math.random() * 900) + 100}) ${Math.floor(Math.random() * 900) + 100}-${Math.floor(Math.random() * 9000) + 1000}`,
                // International format: +1-XXX-XXX-XXXX
                () => `+1-${Math.floor(Math.random() * 900) + 100}-${Math.floor(Math.random() * 900) + 100}-${Math.floor(Math.random() * 9000) + 1000}`,
                // Simple format: XXX-XXX-XXXX
                () => `${Math.floor(Math.random() * 900) + 100}-${Math.floor(Math.random() * 900) + 100}-${Math.floor(Math.random() * 9000) + 1000}`,
                // International with country code: +44-XXXX-XXXXXX
                () => `+44-${Math.floor(Math.random() * 9000) + 1000}-${Math.floor(Math.random() * 900000) + 100000}`,
                // European format: +49-XXX-XXXXXXX
                () => `+49-${Math.floor(Math.random() * 900) + 100}-${Math.floor(Math.random() * 9000000) + 1000000}`
            ];
            
            const randomFormat = formats[Math.floor(Math.random() * formats.length)];
            return randomFormat();
        }

        function downloadPhoneFile(phoneNumber, filename) {
            const content = `Phone Number: ${phoneNumber}\nGenerated: ${new Date().toISOString()}\nType: Test Phone File\n\nThis is a test file generated by CRMTogether PWA Host URI Test Page.`;
            
            const blob = new Blob([content], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        function downloadRandomPhoneFile() {
            const phoneNumber = generateRandomPhoneNumber();
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
            const filename = `test-phone-${timestamp}.phone`;
            
            downloadPhoneFile(phoneNumber, filename);
            
            const display = document.getElementById('phoneFileDisplay');
            display.textContent = `Downloaded: ${filename} (${phoneNumber})`;
        }

        function downloadCustomPhoneFile() {
            const phoneNumber = prompt('Enter a phone number for the test file:');
            if (!phoneNumber) {
                return;
            }
            
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
            const filename = `custom-phone-${timestamp}.phone`;
            
            downloadPhoneFile(phoneNumber, filename);
            
            const display = document.getElementById('phoneFileDisplay');
            display.textContent = `Downloaded: ${filename} (${phoneNumber})`;
        }

        function downloadToDownloadsFolder() {
            const phoneNumber = generateRandomPhoneNumber();
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
            const filename = `test-phone-${timestamp}.phone`;
            
            // Try to download to Downloads folder using a data URI approach
            // Note: This will still use the browser's default download location
            // but we'll provide clear instructions
            downloadPhoneFile(phoneNumber, filename);
            
            const display = document.getElementById('phoneFileDisplay');
            display.textContent = `Downloaded: ${filename} (${phoneNumber}) - Check your Downloads folder or drag the file onto the app window`;
            
            // Show additional instructions
            setTimeout(() => {
                alert(`File downloaded: ${filename}\n\nTo test the app reaction:\n1. Go to your Downloads folder\n2. Find the file: ${filename}\n3. Drag it onto the CRMTogether PWA Host app window\n\nOr the app should automatically detect it if it's watching your Downloads folder.`);
            }, 500);
        }

        // EML file generation functions
        function generateRandomEmailContent() {
            const subjects = [
                "Meeting Request for Next Week",
                "Project Update - Q4 Review",
                "Invoice #INV-2024-001",
                "Vacation Request Approval",
                "New Client Onboarding",
                "System Maintenance Notice",
                "Quarterly Report Available",
                "Team Building Event",
                "Budget Review Meeting",
                "Security Alert - Password Reset"
            ];
            
            const senders = [
                "john.doe@company.com",
                "sarah.smith@company.com", 
                "mike.johnson@company.com",
                "lisa.wilson@company.com",
                "david.brown@company.com",
                "emma.davis@company.com",
                "alex.garcia@company.com",
                "jessica.miller@company.com"
            ];
            
            const recipients = [
                "team@company.com",
                "manager@company.com",
                "support@company.com",
                "hr@company.com",
                "finance@company.com"
            ];
            
            const bodies = [
                "Hello,\n\nI hope this email finds you well. I wanted to follow up on our previous discussion regarding the upcoming project deadline.\n\nBest regards,",
                "Hi there,\n\nPlease find attached the requested documents for your review. Let me know if you need any clarification.\n\nThanks,",
                "Dear Team,\n\nThis is a reminder about the upcoming meeting scheduled for next Tuesday at 2:00 PM.\n\nPlease confirm your attendance.\n\nRegards,",
                "Hello,\n\nI wanted to inform you about the recent changes to our company policies. Please review the attached document.\n\nBest,",
                "Hi,\n\nThank you for your recent inquiry. I've attached the information you requested.\n\nPlease let me know if you have any questions.\n\nKind regards,"
            ];
            
            const subject = subjects[Math.floor(Math.random() * subjects.length)];
            const from = senders[Math.floor(Math.random() * senders.length)];
            const to = recipients[Math.floor(Math.random() * recipients.length)];
            const body = bodies[Math.floor(Math.random() * bodies.length)];
            const date = new Date();
            
            return {
                subject: subject,
                from: from,
                to: to,
                body: body,
                date: date.toUTCString()
            };
        }

        function generateEmlContent(emailData) {
            const boundary = "----=_Part_" + Math.random().toString(36).substr(2, 9);
            
            return `Return-Path: <${emailData.from}>
Received: from mail.company.com (mail.company.com [192.168.1.100])
	by mail.company.com (Postfix) with ESMTP id 1234567890
	for <${emailData.to}>; ${emailData.date}
Message-ID: <${Math.random().toString(36).substr(2, 16)}@company.com>
Date: ${emailData.date}
From: ${emailData.from}
To: ${emailData.to}
Subject: ${emailData.subject}
MIME-Version: 1.0
Content-Type: multipart/alternative; boundary="${boundary}"

--${boundary}
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 7bit

${emailData.body}

--${boundary}
Content-Type: text/html; charset=UTF-8
Content-Transfer-Encoding: 7bit

<html>
<body>
<p>${emailData.body.replace(/\n/g, '<br>')}</p>
</body>
</html>

--${boundary}--`;
        }

        function downloadEmlFile(emailData, filename) {
            const content = generateEmlContent(emailData);
            
            const blob = new Blob([content], { type: 'message/rfc822' });
            const url = window.URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        function downloadRandomEmlFile() {
            const emailData = generateRandomEmailContent();
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
            const filename = `test-email-${timestamp}.eml`;
            
            downloadEmlFile(emailData, filename);
            
            const display = document.getElementById('emlFileDisplay');
            display.textContent = `Downloaded: ${filename} (${emailData.subject})`;
        }

        function downloadCustomEmlFile() {
            const subject = prompt('Enter email subject:') || 'Test Email Subject';
            const from = prompt('Enter sender email:') || 'test@company.com';
            const to = prompt('Enter recipient email:') || 'recipient@company.com';
            const body = prompt('Enter email body:') || 'This is a test email body.';
            
            const emailData = {
                subject: subject,
                from: from,
                to: to,
                body: body,
                date: new Date().toUTCString()
            };
            
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
            const filename = `custom-email-${timestamp}.eml`;
            
            downloadEmlFile(emailData, filename);
            
            const display = document.getElementById('emlFileDisplay');
            display.textContent = `Downloaded: ${filename} (${emailData.subject})`;
        }

        function downloadEmlToDownloadsFolder() {
            const emailData = generateRandomEmailContent();
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
            const filename = `test-email-${timestamp}.eml`;
            
            downloadEmlFile(emailData, filename);
            
            const display = document.getElementById('emlFileDisplay');
            display.textContent = `Downloaded: ${filename} (${emailData.subject}) - Check your Downloads folder or drag the file onto the app window`;
            
            // Show additional instructions
            setTimeout(() => {
                alert(`EML file downloaded: ${filename}\n\nSubject: ${emailData.subject}\nFrom: ${emailData.from}\nTo: ${emailData.to}\n\nTo test the app reaction:\n1. Go to your Downloads folder\n2. Find the file: ${filename}\n3. Drag it onto the CRMTogether PWA Host app window\n\nOr the app should automatically detect it if it's watching your Downloads folder.`);
            }, 500);
        }

        // Log when page loads
        console.log('CRMTogether PWA Host URI Test Page loaded');
        console.log('Available test functions: testFunction, getPageInfo');
        console.log('Available phone functions: downloadRandomPhoneFile, downloadCustomPhoneFile');
        console.log('Available EML functions: downloadRandomEmlFile, downloadCustomEmlFile');
    </script>
</body>
</html>
